name: 🚀 Deploy App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 🚀 Deploy to Server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: 161.118.166.49
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            
            echo "📥 Setting up deployment directory..."
            cd /home/ubuntu
            
            if [ -d "brv-app" ]; then
              cd brv-app
              docker compose down || true
              cd ..
              rm -rf brv-app
            fi
            
            echo "📥 Cloning fresh repository..."
            git clone https://github.com/Aarav500/brv-app.git
            cd brv-app
            
            echo "📝 Creating .env file..."
            printf '%s\n' '${{ secrets.ENV }}' > .env.backup
            
            echo "🔍 Creating temporary clean .env for Docker Compose..."
            touch .env
            
            echo "🔍 Verifying .env.backup file..."
            if [ -f .env.backup ]; then
              echo "✅ .env.backup file created successfully"
              echo "📊 .env.backup file has $(wc -l < .env.backup) lines"
              echo "📋 First few lines of .env.backup:"
              head -3 .env.backup | sed 's/=.*$/=***/'
            else
              echo "❌ Failed to create .env.backup file"
              exit 1
            fi
            
            echo "📂 Ensuring required directories..."
            mkdir -p /home/ubuntu/logs
            mkdir -p /home/ubuntu/CV
            mkdir -p secrets
            
            echo "🔑 Creating Google credentials..."
            echo '${{ secrets.GOOGLE_JSON_BASE64 }}' | base64 -d > secrets/google.json
            
            sed -i 's|GOOGLE_SERVICE_ACCOUNT_FILE=.*|GOOGLE_SERVICE_ACCOUNT_FILE=/app/secrets/google.json|' .env.backup
            
            echo "🧹 Cleaning up old containers and images..."
            docker system prune -f
            
            echo "🚀 Building and starting containers..."
            docker compose up -d --build --remove-orphans
            
            echo "🔄 Restoring complete .env file..."
            mv .env.backup .env
            
            echo "⏳ Waiting for services to start..."
            sleep 10
            
            echo "🔍 Checking service status..."
            docker compose ps
            docker compose logs --tail=20
            
            echo "✅ Deploy complete!"
            echo "🌐 App should be available at: http://161.118.166.49:8501"