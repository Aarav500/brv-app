name: ğŸš€ Deploy App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Deploy to Server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: 161.118.166.49
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e  # Exit on any error
            
            echo "ğŸ“¥ Setting up deployment directory..."
            cd /home/ubuntu
            
            # Clean up any existing deployment
            if [ -d "brv-app" ]; then
              cd brv-app
              docker compose down || true
              cd ..
              rm -rf brv-app
            fi
            
            echo "ğŸ“¥ Cloning fresh repository..."
            git clone https://github.com/Aarav500/brv-app.git
            cd brv-app
            
            echo "ğŸ“ Creating .env file..."
            # Write ENV secret to .env file with proper handling of multiline content
            cat > .env << 'ENVEOF'
${{ secrets.ENV }}
ENVEOF
            
            # Verify .env file was created correctly
            echo "ğŸ” Verifying .env file..."
            if [ -f .env ]; then
              echo "âœ… .env file created successfully"
              echo "ğŸ“Š .env file has $(wc -l < .env) lines"
              # Show first few lines (without sensitive data)
              echo "ğŸ“‹ First few lines of .env:"
              head -3 .env | sed 's/=.*$/=***/'
            else
              echo "âŒ Failed to create .env file"
              exit 1
            fi
            
            echo "ğŸ“‚ Ensuring required directories..."
            mkdir -p /home/ubuntu/logs
            mkdir -p /home/ubuntu/CV
            mkdir -p secrets
            
            echo "ğŸ”‘ Creating Google credentials..."
            echo '${{ secrets.GOOGLE_JSON_BASE64 }}' | base64 -d > secrets/google.json
            
            # Update Google service account file path in .env to point to container path
            sed -i 's|GOOGLE_SERVICE_ACCOUNT_FILE=.*|GOOGLE_SERVICE_ACCOUNT_FILE=/app/secrets/google.json|' .env
            
            echo "ğŸ§¹ Cleaning up old containers and images..."
            docker system prune -f
            
            echo "ğŸš€ Building and starting containers..."
            docker compose up -d --build --remove-orphans
            
            echo "â³ Waiting for services to start..."
            sleep 10
            
            echo "ğŸ” Checking service status..."
            docker compose ps
            docker compose logs --tail=20
            
            echo "âœ… Deploy complete!"
            echo "ğŸŒ App should be available at: http://161.118.166.49:8501"