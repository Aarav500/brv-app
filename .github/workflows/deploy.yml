name: ğŸš€ Deploy App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Deploy to Server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: 161.118.166.49
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            
            echo "ğŸ“¥ Setting up deployment directory..."
            cd /home/ubuntu
            
            if [ -d "brv-app" ]; then
              cd brv-app
              docker compose down || true
              cd ..
              rm -rf brv-app
            fi
            
            echo "ğŸ“¥ Cloning fresh repository..."
            git clone https://github.com/Aarav500/brv-app.git
            cd brv-app
            
            echo "ğŸ“ Creating .env file..."
            printf '%s\n' '${{ secrets.ENV }}' > .env.backup
            
            echo "ğŸ” Creating temporary clean .env for Docker Compose..."
            touch .env
            
            echo "ğŸ” Verifying .env.backup file..."
            if [ -f .env.backup ]; then
              echo "âœ… .env.backup file created successfully"
              echo "ğŸ“Š .env.backup file has $(wc -l < .env.backup) lines"
              echo "ğŸ“‹ First few lines of .env.backup:"
              head -3 .env.backup | sed 's/=.*$/=***/'
            else
              echo "âŒ Failed to create .env.backup file"
              exit 1
            fi
            
            echo "ğŸ“‚ Ensuring required directories..."
            mkdir -p /home/ubuntu/logs
            mkdir -p /home/ubuntu/CV
            mkdir -p secrets
            
            echo "ğŸ”‘ Creating Google credentials..."
            echo '${{ secrets.GOOGLE_JSON_BASE64 }}' | base64 -d > secrets/google.json
            
            sed -i 's|GOOGLE_SERVICE_ACCOUNT_FILE=.*|GOOGLE_SERVICE_ACCOUNT_FILE=/app/secrets/google.json|' .env.backup
            
            echo "ğŸ§¹ Cleaning up old containers and images..."
            docker system prune -f
            
            echo "ğŸš€ Building and starting containers..."
            docker compose up -d --build --remove-orphans
            
            echo "ğŸ”„ Restoring complete .env file..."
            mv .env.backup .env
            
            echo "â³ Waiting for services to start..."
            sleep 10
            
            echo "ğŸ” Checking service status..."
            docker compose ps
            docker compose logs --tail=20
            
            echo "âœ… Deploy complete!"
            echo "ğŸŒ App should be available at: http://161.118.166.49:8501"