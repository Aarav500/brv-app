name: ğŸš€ Deploy App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Deploy to Server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: 161.118.166.49
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e  # Exit on any error
            
            echo "ğŸ“¥ Setting up deployment directory..."
            cd /home/ubuntu
            
            # Clean up any existing deployment
            if [ -d "brv-app" ]; then
              cd brv-app
              docker compose down || true
              cd ..
              rm -rf brv-app
            fi
            
            echo "ğŸ“¥ Cloning fresh repository..."
            git clone https://github.com/Aarav500/brv-app.git
            cd brv-app
            
            echo "ğŸ“‚ Ensuring required directories..."
            mkdir -p /home/ubuntu/logs
            mkdir -p /home/ubuntu/CV
            mkdir -p secrets
            
            echo "ğŸ”‘ Creating Google credentials..."
            echo '${{ secrets.GOOGLE_JSON_BASE64 }}' | base64 -d > secrets/google.json
            
            echo "ğŸ§¹ Cleaning up old containers and images..."
            docker system prune -f
            
            echo "ğŸš€ Building and starting containers..."
            docker compose up -d --build --remove-orphans
            
            echo "â³ Waiting for services to start..."
            sleep 10
            
            echo "ğŸ” Checking service status..."
            docker compose ps
            docker compose logs --tail=20
            
            echo "âœ… Deploy complete!"
            echo "ğŸŒ App should be available at: http://161.118.166.49:8501"